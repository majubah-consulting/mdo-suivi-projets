<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MDO - Suivi Projets Entrepreneuriaux</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Lato:wght@300;400;600;700;900&display=swap');
        
        body {
            font-family: 'Lato', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #194759 0%, #416573 100%);
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .majubah-blue {
            color: #194759;
        }
        .majubah-orange {
            color: #eb5436;
        }
        .bg-majubah-blue {
            background-color: #194759;
        }
        .bg-majubah-orange {
            background-color: #eb5436;
        }
        .border-majubah-orange {
            border-color: #eb5436;
        }
        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .logo-img {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }
        .btn-deconnexion {
            background-color: #eb5436;
            color: white;
            transition: all 0.3s ease;
        }
        .btn-deconnexion:hover {
            background-color: #194759;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(25, 71, 89, 0.3);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Configuration Firebase - MAJUBAH CONSULTING
        const firebaseConfig = {
            apiKey: "AIzaSyCbIINol2HAL2qHzR3hUg2j9e-01-8oQiQ",
            authDomain: "mdo-majubah-2025.firebaseapp.com",
            projectId: "mdo-majubah-2025",
            storageBucket: "mdo-majubah-2025.firebasestorage.app",
            messagingSenderId: "797761054593",
            appId: "1:797761054593:web:8e6eae03cec23f32672a80"
        };

        // Initialisation Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // Liste des 19 √©tudiants MDO 2024-2026
        const studentsList = [
            { id: 'MDO-001', prenom: 'Chlo√©', nom: 'BARBIER' },
            { id: 'MDO-002', prenom: 'Floryane', nom: 'BELHAIRE' },
            { id: 'MDO-003', prenom: 'Marylene', nom: 'BOUCHARD' },
            { id: 'MDO-004', prenom: 'Paul', nom: 'CAMPORRO' },
            { id: 'MDO-005', prenom: 'Louis', nom: 'CHALLOIS' },
            { id: 'MDO-006', prenom: 'Charlene', nom: 'DEROUIN' },
            { id: 'MDO-007', prenom: 'Zoe', nom: 'DIARD' },
            { id: 'MDO-008', prenom: 'Victor', nom: 'DUCHESNE' },
            { id: 'MDO-009', prenom: 'Matheo', nom: 'GAILLARD' },
            { id: 'MDO-010', prenom: 'Clara', nom: 'GAUTIER' },
            { id: 'MDO-011', prenom: 'Charly', nom: 'GUILLOUET' },
            { id: 'MDO-012', prenom: 'Stanislas', nom: 'JOOS' },
            { id: 'MDO-013', prenom: 'Justine', nom: 'JOUANNET' },
            { id: 'MDO-014', prenom: 'Julie', nom: 'LAMOTTE GOIMIER' },
            { id: 'MDO-015', prenom: 'Margaux', nom: 'LE SURTEL' },
            { id: 'MDO-016', prenom: 'Charlene', nom: 'LEDARD' },
            { id: 'MDO-017', prenom: 'Kylian', nom: 'MARAIS' },
            { id: 'MDO-018', prenom: 'Paul', nom: 'MARIN' },
            { id: 'MDO-019', prenom: 'Hugo', nom: 'VALTIER' }
        ];

        // Helper pour sauvegarder les donn√©es dans Firebase
        const saveToFirebase = async (studentId, data) => {
            try {
                console.log('üíæ SAUVEGARDE Firebase pour', studentId);
                console.log('üì¶ Donn√©es √† sauvegarder:', data);
                await db.collection('students').doc(studentId).set(data, { merge: true });
                console.log('‚úÖ Donn√©es sauvegard√©es dans Firebase avec succ√®s !');
                console.log('üîó V√©rifiez dans Firebase Console: https://console.firebase.google.com');
                return true;
            } catch (error) {
                console.error('‚ùå ERREUR Firebase sauvegarde:', error);
                console.error('Code erreur:', error.code);
                console.error('Message:', error.message);
                alert('‚ùå Erreur de sauvegarde Firebase: ' + error.message + '\nV√©rifiez les r√®gles Firestore !');
                return false;
            }
        };

        // Helper pour charger les donn√©es depuis Firebase
        const loadFromFirebase = async (studentId) => {
            try {
                console.log('üì• CHARGEMENT Firebase pour', studentId);
                const doc = await db.collection('students').doc(studentId).get();
                if (doc.exists) {
                    const data = doc.data();
                    console.log('‚úÖ Donn√©es charg√©es depuis Firebase:', data);
                    return data;
                } else {
                    console.log('‚ÑπÔ∏è Aucune donn√©e Firebase pour', studentId);
                    return null;
                }
            } catch (error) {
                console.error('‚ùå ERREUR Firebase chargement:', error);
                console.error('Code erreur:', error.code);
                console.error('Message:', error.message);
                return null;
            }
        };

        // Donn√©es initiales des comp√©tences bas√©es sur le r√©f√©rentiel
        const competencesRef = [
            {
                id: 'C1.1',
                code: 'C1.1.A1',
                titre: 'Veille √©conomique et concurrentielle',
                description: 'Organiser un syst√®me pertinent de veille √©conomique, concurrentielle, IT, environnementale',
                critere: 'CrC1.1 : La veille environnementale est mobilis√©e et justifi√©e par un choix de sources fiables et par l\'usage d\'outils comme le PESTEL',
                activite: 'R√©alisation d\'un diagnostic'
            },
            {
                id: 'C1.2',
                code: 'C1.2.A1',
                titre: 'Analyse strat√©gique (SWOT)',
                description: 'R√©aliser une analyse interne et externe de l\'organisation',
                critere: 'CrC1.2 : Le SWOT est coh√©rent et justifi√© par les √©l√©ments de veille',
                activite: 'R√©alisation d\'un diagnostic'
            },
            {
                id: 'C1.3',
                code: 'C1.3.A2',
                titre: 'Mission, vision et valeurs',
                description: 'D√©finir ou red√©finir la mission, la vision et les valeurs de l\'entreprise',
                critere: 'CrC1.3 : La mission, la vision et les valeurs et le mod√®le de gouvernance sont pr√©cis√©ment d√©finis',
                activite: '√âlaboration de la strat√©gie'
            },
            {
                id: 'C1.4',
                code: 'C1.4.A2',
                titre: 'Montage juridique',
                description: 'Participer au montage juridique et √† la structuration de la gouvernance',
                critere: 'CrC1.4: Le choix du montage juridique de la structure est justifi√©',
                activite: '√âlaboration de la strat√©gie'
            },
            {
                id: 'C1.5',
                code: 'C1.5.A2',
                titre: 'Objectifs SMART',
                description: 'D√©finir les objectifs √† court, moyen, long terme',
                critere: 'CrC1.5: Les objectifs sont d√©finis selon le model SMART',
                activite: '√âlaboration de la strat√©gie'
            },
            {
                id: 'C1.6',
                code: 'C1.6.A3',
                titre: 'Adaptation strat√©gique',
                description: 'Faire √©voluer les choix strat√©giques en fonction des opportunit√©s',
                critere: 'CrC1.6: R√©pondre aux enjeux de d√©veloppement des activit√©s',
                activite: 'R√©vision/adaptation de la strat√©gie'
            },
            {
                id: 'C1.7',
                code: 'C1.7.A3',
                titre: 'Management des risques',
                description: 'Construire une strat√©gie de management des risques',
                critere: 'CrC1.7: Tenir compte des risques les plus critiques de la cartographie',
                activite: 'R√©vision/adaptation de la strat√©gie'
            },
            {
                id: 'C1.8',
                code: 'C1.8.A3',
                titre: 'Strat√©gie RSE',
                description: 'Concevoir ou d√©velopper une strat√©gie RSE',
                critere: 'CrC1.8: Tenir compte de la matrice de mat√©rialit√© pour les enjeux de RSE',
                activite: 'R√©vision/adaptation de la strat√©gie'
            },
            {
                id: 'C1.9',
                code: 'C1.9.A4',
                titre: 'Strat√©gie de moyens',
                description: 'D√©cliner une strat√©gie de moyens (RH, commercial, marketing, production)',
                critere: 'CrC1.9 : Les objectifs d√©clin√©s pour la strat√©gie de moyens sont SMART',
                activite: 'D√©finition des moyens'
            },
            {
                id: 'C1.10',
                code: 'C1.10.A4',
                titre: 'Sources de financement',
                description: '√âvaluation comparative des mod√®les de croissance et sources de financement',
                critere: 'CrC1.10 : Le business model r√©alis√© du projet de cr√©ation est coh√©rent',
                activite: 'D√©finition des moyens'
            },
            {
                id: 'C1.11',
                code: 'C1.11.A4',
                titre: 'Pitch investisseur',
                description: 'Pr√©senter la strat√©gie aux investisseurs',
                critere: 'CrC1.11 : Le candidat maitrise son projet et sait le d√©fendre',
                activite: 'D√©finition des moyens'
            }
        ];

        // Sections du Business Plan
        const sectionsBP = [
            'R√©sum√© ex√©cutif',
            'Le porteur de projet',
            'L\'offre',
            'La cible',
            'Le march√©',
            'La concurrence',
            'Le marketing',
            'La communication',
            'Partenaires et fournisseurs',
            'La RSE',
            'La gouvernance',
            'La strat√©gie',
            'Aspects juridiques et fiscaux',
            'Pr√©visions financi√®res (3-5 ans)',
            'Les financements',
            'D√©veloppement de l\'entreprise',
            'Conclusion'
        ];

        // Composant de connexion
        function LoginPage({ onLogin }) {
            const [userType, setUserType] = useState('student');
            const [studentId, setStudentId] = useState('');
            const [password, setPassword] = useState('');

            const handleLogin = (e) => {
                e.preventDefault();
                if (userType === 'teacher' && password === 'admin2026') {
                    onLogin('teacher', 'Formateur');
                } else if (userType === 'student' && studentId) {
                    onLogin('student', `√âtudiant ${studentId}`);
                } else {
                    alert('Identifiants incorrects');
                }
            };

            return (
                <div className="min-h-screen gradient-bg flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="flex justify-center mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" className="w-24 h-24">
                                    <ellipse cx="100" cy="90" rx="50" ry="45" fill="#194759"/>
                                    <path d="M 60 60 Q 50 40 65 50 Z" fill="#194759"/>
                                    <path d="M 140 60 Q 150 40 135 50 Z" fill="#194759"/>
                                    <ellipse cx="80" cy="85" rx="8" ry="12" fill="#eb5436"/>
                                    <ellipse cx="120" cy="85" rx="8" ry="12" fill="#eb5436"/>
                                    <ellipse cx="82" cy="83" rx="3" ry="5" fill="#ffffff"/>
                                    <ellipse cx="122" cy="83" rx="3" ry="5" fill="#ffffff"/>
                                    <ellipse cx="100" cy="105" rx="15" ry="12" fill="#416573"/>
                                    <path d="M 100 100 L 95 108 Q 100 110 105 108 Z" fill="#eb5436"/>
                                    <line x1="70" y1="100" x2="40" y2="95" stroke="#194759" strokeWidth="2"/>
                                    <line x1="70" y1="105" x2="40" y2="105" stroke="#194759" strokeWidth="2"/>
                                    <line x1="130" y1="100" x2="160" y2="95" stroke="#194759" strokeWidth="2"/>
                                    <line x1="130" y1="105" x2="160" y2="105" stroke="#194759" strokeWidth="2"/>
                                    <path d="M 70 120 Q 100 140 130 120" fill="none" stroke="#194759" strokeWidth="3"/>
                                </svg>
                            </div>
                            <h1 className="text-3xl font-bold majubah-blue mb-2">MDO 2024-2026</h1>
                            <p className="text-gray-600">Suivi des projets entrepreneuriaux</p>
                            <p className="text-sm majubah-orange font-semibold mt-2">MAJUBAH CONSULTING</p>
                        </div>

                        <form onSubmit={handleLogin}>
                            <div className="mb-6">
                                <label className="block text-gray-700 font-semibold mb-3">Je suis :</label>
                                <div className="flex gap-4">
                                    <button
                                        type="button"
                                        onClick={() => setUserType('student')}
                                        className={`flex-1 py-3 px-4 rounded-lg font-medium transition ${
                                            userType === 'student'
                                                ? 'bg-majubah-orange text-white'
                                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                    >
                                        <i className="fas fa-user-graduate mr-2"></i>
                                        √âtudiant
                                    </button>
                                    <button
                                        type="button"
                                        onClick={() => setUserType('teacher')}
                                        className={`flex-1 py-3 px-4 rounded-lg font-medium transition ${
                                            userType === 'teacher'
                                                ? 'bg-majubah-blue text-white'
                                                : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                        }`}
                                    >
                                        <i className="fas fa-chalkboard-teacher mr-2"></i>
                                        Formateur
                                    </button>
                                </div>
                            </div>

                            {userType === 'student' ? (
                                <div className="mb-6">
                                    <label className="block text-gray-700 font-medium mb-2">
                                        S√©lectionnez votre nom
                                    </label>
                                    <select
                                        value={studentId}
                                        onChange={(e) => setStudentId(e.target.value)}
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                        required
                                    >
                                        <option value="">-- Choisissez votre nom --</option>
                                        {studentsList.map(student => (
                                            <option key={student.id} value={student.id}>
                                                {student.id} - {student.prenom} {student.nom}
                                            </option>
                                        ))}
                                    </select>
                                </div>
                            ) : (
                                <div className="mb-6">
                                    <label className="block text-gray-700 font-medium mb-2">
                                        Mot de passe
                                    </label>
                                    <input
                                        type="password"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        placeholder="Mot de passe formateur"
                                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                        required
                                    />
                                    <p className="text-sm text-gray-500 mt-2">
                                        <i className="fas fa-info-circle mr-1"></i>
                                        D√©mo: mot de passe = admin2026
                                    </p>
                                </div>
                            )}

                            <button
                                type="submit"
                                className="w-full bg-majubah-orange text-white py-3 rounded-lg font-semibold hover:bg-orange-600 transition"
                            >
                                Se connecter
                            </button>
                        </form>
                        
                        <div className="mt-6 text-center text-sm text-gray-500">
                            <p>Propuls√© par <span className="font-semibold text-majubah-orange">MAJUBAH CONSULTING</span></p>
                        </div>
                    </div>
                </div>
            );
        }

        // Composant Dashboard √âtudiant
        function StudentDashboard({ studentName, onLogout }) {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [loading, setLoading] = useState(true);
            const [competences, setCompetences] = useState(competencesRef.map(c => ({ ...c, statut: 'non_commence', autoEval: '', notes: '', commentaireFormateur: '' })));
            const [sections, setSections] = useState(sectionsBP.map(s => ({ nom: s, complete: false, notes: '', commentaireFormateur: '' })));
            const [projectInfo, setProjectInfo] = useState({ nom: '', description: '', secteur: '', commentaireFormateur: '' });

            // Charger les donn√©es depuis Firebase au montage du composant
            useEffect(() => {
                const loadData = async () => {
                    setLoading(true);
                    const firebaseData = await loadFromFirebase(studentName);
                    
                    if (firebaseData) {
                        if (firebaseData.competences) setCompetences(firebaseData.competences);
                        if (firebaseData.sections) setSections(firebaseData.sections);
                        if (firebaseData.projectInfo) setProjectInfo(firebaseData.projectInfo);
                    }
                    
                    setLoading(false);
                };
                
                loadData();
            }, [studentName]);

            // Sauvegarder dans Firebase √† chaque modification
            useEffect(() => {
                if (!loading) {
                    const saveData = async () => {
                        await saveToFirebase(studentName, {
                            studentName,
                            competences,
                            sections,
                            projectInfo,
                            lastUpdate: new Date().toISOString()
                        });
                    };
                    saveData();
                }
            }, [competences, sections, projectInfo, studentName, loading]);

            const updateCompetence = (id, field, value) => {
                setCompetences(prev => prev.map(c => c.id === id ? { ...c, [field]: value } : c));
            };

            const updateSection = (index, field, value) => {
                setSections(prev => prev.map((s, i) => i === index ? { ...s, [field]: value } : s));
            };

            // Fonction pour exporter les donn√©es
            const exportData = () => {
                const dataToExport = {
                    studentName,
                    projectInfo,
                    competences,
                    sections,
                    exportDate: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `MDO_${studentName}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            // Fonction pour importer les donn√©es
            const importData = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            if (importedData.projectInfo) setProjectInfo(importedData.projectInfo);
                            if (importedData.competences) setCompetences(importedData.competences);
                            if (importedData.sections) setSections(importedData.sections);
                            alert('Donn√©es import√©es avec succ√®s ! ‚úÖ');
                        } catch (error) {
                            alert('Erreur lors de l\'importation des donn√©es. V√©rifiez le fichier.');
                        }
                    };
                    reader.readAsText(file);
                }
            };

            const progressionGlobale = Math.round(
                (competences.filter(c => c.statut === 'termine').length / competences.length) * 100
            );

            const sectionsCompletes = sections.filter(s => s.complete).length;
            const progressionBP = Math.round((sectionsCompletes / sections.length) * 100);

            const StatutBadge = ({ statut }) => {
                const colors = {
                    non_commence: 'bg-gray-200 text-gray-700',
                    en_cours: 'bg-yellow-200 text-yellow-800',
                    termine: 'bg-green-200 text-green-800'
                };
                const labels = {
                    non_commence: 'Non commenc√©',
                    en_cours: 'En cours',
                    termine: 'Termin√©'
                };
                return (
                    <span className={`px-3 py-1 rounded-full text-xs font-semibold ${colors[statut]}`}>
                        {labels[statut]}
                    </span>
                );
            };

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-majubah-orange mb-4"></div>
                            <p className="text-xl text-gray-700 font-semibold">Chargement de vos donn√©es...</p>
                            <p className="text-sm text-gray-500 mt-2">üêÜ MAJUBAH CONSULTING</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <header className="gradient-bg text-white shadow-lg">
                        <div className="container mx-auto px-4 py-4">
                            <div className="flex justify-between items-center">
                                <div className="logo-container">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" className="w-12 h-12">
                                        <ellipse cx="100" cy="90" rx="50" ry="45" fill="#ffffff"/>
                                        <path d="M 60 60 Q 50 40 65 50 Z" fill="#ffffff"/>
                                        <path d="M 140 60 Q 150 40 135 50 Z" fill="#ffffff"/>
                                        <ellipse cx="80" cy="85" rx="8" ry="12" fill="#eb5436"/>
                                        <ellipse cx="120" cy="85" rx="8" ry="12" fill="#eb5436"/>
                                        <ellipse cx="82" cy="83" rx="3" ry="5" fill="#194759"/>
                                        <ellipse cx="122" cy="83" rx="3" ry="5" fill="#194759"/>
                                        <ellipse cx="100" cy="105" rx="15" ry="12" fill="#f0f0f0"/>
                                        <path d="M 100 100 L 95 108 Q 100 110 105 108 Z" fill="#eb5436"/>
                                        <line x1="70" y1="100" x2="40" y2="95" stroke="#ffffff" strokeWidth="2"/>
                                        <line x1="70" y1="105" x2="40" y2="105" stroke="#ffffff" strokeWidth="2"/>
                                        <line x1="130" y1="100" x2="160" y2="95" stroke="#ffffff" strokeWidth="2"/>
                                        <line x1="130" y1="105" x2="160" y2="105" stroke="#ffffff" strokeWidth="2"/>
                                        <path d="M 70 120 Q 100 140 130 120" fill="none" stroke="#ffffff" strokeWidth="3"/>
                                    </svg>
                                    <div>
                                        <h1 className="text-2xl font-bold">MDO - Projet Entrepreneurial</h1>
                                        <p className="text-blue-100 text-sm">
                                            {studentName} 
                                            <span className="ml-3 bg-green-500 text-white px-2 py-1 rounded-full text-xs">
                                                <i className="fas fa-cloud-upload-alt mr-1"></i>
                                                Sauvegarde automatique
                                            </span>
                                        </p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <button
                                        onClick={exportData}
                                        className="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition"
                                        title="Exporter mes donn√©es"
                                    >
                                        <i className="fas fa-download mr-2"></i>
                                        Sauvegarder
                                    </button>
                                    <label className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition cursor-pointer">
                                        <i className="fas fa-upload mr-2"></i>
                                        Importer
                                        <input
                                            type="file"
                                            accept=".json"
                                            onChange={importData}
                                            className="hidden"
                                        />
                                    </label>
                                    <button
                                        onClick={onLogout}
                                        className="btn-deconnexion px-4 py-2 rounded-lg font-medium"
                                    >
                                        <i className="fas fa-sign-out-alt mr-2"></i>
                                        D√©connexion
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    {/* Navigation */}
                    <nav className="bg-white border-b border-gray-200 sticky top-0 z-10">
                        <div className="container mx-auto px-4">
                            <div className="flex space-x-8">
                                {[
                                    { id: 'dashboard', label: 'Tableau de bord', icon: 'chart-line' },
                                    { id: 'project', label: 'Mon projet', icon: 'lightbulb' },
                                    { id: 'competences', label: 'Comp√©tences', icon: 'tasks' },
                                    { id: 'businessplan', label: 'Business Plan', icon: 'file-alt' },
                                    { id: 'feedbacks', label: 'Feedbacks formateur', icon: 'comments' }
                                ].map(tab => (
                                    <button
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)}
                                        className={`py-4 px-2 border-b-2 font-medium transition ${
                                            activeTab === tab.id
                                                ? 'border-majubah-orange text-majubah-orange'
                                                : 'border-transparent text-gray-500 hover:text-gray-700'
                                        }`}
                                    >
                                        <i className={`fas fa-${tab.icon} mr-2`}></i>
                                        {tab.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </nav>

                    {/* Contenu */}
                    <main className="container mx-auto px-4 py-8">
                        {activeTab === 'dashboard' && (
                            <div>
                                <h2 className="text-3xl font-bold text-gray-800 mb-6">Tableau de bord</h2>
                                
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                    <div className="bg-white rounded-xl shadow-md p-6 card-hover">
                                        <div className="flex items-center justify-between mb-4">
                                            <h3 className="text-gray-600 font-semibold">Progression globale</h3>
                                            <i className="fas fa-chart-pie text-majubah-orange text-2xl"></i>
                                        </div>
                                        <div className="text-4xl font-bold text-majubah-orange mb-2">{progressionGlobale}%</div>
                                        <div className="w-full bg-gray-200 rounded-full h-3">
                                            <div
                                                className="bg-majubah-orange h-3 rounded-full transition-all duration-500"
                                                style={{ width: `${progressionGlobale}%` }}
                                            ></div>
                                        </div>
                                    </div>

                                    <div className="bg-white rounded-xl shadow-md p-6 card-hover">
                                        <div className="flex items-center justify-between mb-4">
                                            <h3 className="text-gray-600 font-semibold">Comp√©tences</h3>
                                            <i className="fas fa-check-circle text-green-600 text-2xl"></i>
                                        </div>
                                        <div className="text-4xl font-bold text-green-600 mb-2">
                                            {competences.filter(c => c.statut === 'termine').length}/{competences.length}
                                        </div>
                                        <p className="text-gray-600 text-sm">comp√©tences valid√©es</p>
                                    </div>

                                    <div className="bg-white rounded-xl shadow-md p-6 card-hover">
                                        <div className="flex items-center justify-between mb-4">
                                            <h3 className="text-gray-600 font-semibold">Business Plan</h3>
                                            <i className="fas fa-file-invoice text-blue-600 text-2xl"></i>
                                        </div>
                                        <div className="text-4xl font-bold text-blue-600 mb-2">{progressionBP}%</div>
                                        <p className="text-gray-600 text-sm">{sectionsCompletes}/{sections.length} sections</p>
                                    </div>
                                </div>

                                {/* √âch√©ances importantes */}
                                <div className="bg-white rounded-xl shadow-md p-6 mb-8">
                                    <h3 className="text-xl font-bold text-gray-800 mb-4">
                                        <i className="fas fa-calendar-alt text-majubah-orange mr-2"></i>
                                        √âch√©ances importantes
                                    </h3>
                                    <div className="space-y-3">
                                        <div className="flex items-center p-3 bg-red-50 rounded-lg">
                                            <i className="fas fa-exclamation-circle text-red-600 mr-3"></i>
                                            <div>
                                                <p className="font-semibold text-gray-800">Rendu du dossier</p>
                                                <p className="text-sm text-gray-600">8 juin 2026 - Dossier complet (50 pages) + annexes</p>
                                            </div>
                                        </div>
                                        <div className="flex items-center p-3 bg-orange-50 rounded-lg">
                                            <i className="fas fa-microphone text-orange-600 mr-3"></i>
                                            <div>
                                                <p className="font-semibold text-gray-800">Soutenance orale</p>
                                                <p className="text-sm text-gray-600">1-3 juillet 2026 - Pitch investisseur (10 min + 25 min √©changes)</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Activit√© r√©cente */}
                                <div className="bg-white rounded-xl shadow-md p-6">
                                    <h3 className="text-xl font-bold text-gray-800 mb-4">
                                        <i className="fas fa-history text-majubah-orange mr-2"></i>
                                        Comp√©tences par activit√©
                                    </h3>
                                    <div className="space-y-4">
                                        {['R√©alisation d\'un diagnostic', '√âlaboration de la strat√©gie', 'R√©vision/adaptation de la strat√©gie', 'D√©finition des moyens'].map((activite, idx) => {
                                            const compActivite = competences.filter(c => c.activite === activite);
                                            const completes = compActivite.filter(c => c.statut === 'termine').length;
                                            const progress = (completes / compActivite.length) * 100;
                                            
                                            return (
                                                <div key={idx}>
                                                    <div className="flex justify-between items-center mb-2">
                                                        <span className="font-medium text-gray-700">{activite}</span>
                                                        <span className="text-sm text-gray-600">{completes}/{compActivite.length}</span>
                                                    </div>
                                                    <div className="w-full bg-gray-200 rounded-full h-2">
                                                        <div
                                                            className="bg-gradient-to-r from-orange-500 to-orange-600 h-2 rounded-full transition-all duration-500"
                                                            style={{ width: `${progress}%` }}
                                                        ></div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'project' && (
                            <div>
                                <h2 className="text-3xl font-bold text-gray-800 mb-6">Mon projet entrepreneurial</h2>
                                
                                <div className="bg-white rounded-xl shadow-md p-6">
                                    <div className="space-y-6">
                                        <div>
                                            <label className="block text-gray-700 font-semibold mb-2">
                                                Nom du projet / entreprise
                                            </label>
                                            <input
                                                type="text"
                                                value={projectInfo.nom}
                                                onChange={(e) => setProjectInfo({ ...projectInfo, nom: e.target.value })}
                                                placeholder="Ex: EcoTech Solutions"
                                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-gray-700 font-semibold mb-2">
                                                Secteur d'activit√©
                                            </label>
                                            <input
                                                type="text"
                                                value={projectInfo.secteur}
                                                onChange={(e) => setProjectInfo({ ...projectInfo, secteur: e.target.value })}
                                                placeholder="Ex: Technologies vertes, E-commerce, Services..."
                                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                            />
                                        </div>

                                        <div>
                                            <label className="block text-gray-700 font-semibold mb-2">
                                                Description du projet (pitch court)
                                            </label>
                                            <textarea
                                                value={projectInfo.description}
                                                onChange={(e) => setProjectInfo({ ...projectInfo, description: e.target.value })}
                                                placeholder="D√©crivez votre projet en quelques lignes : probl√®me identifi√©, solution propos√©e, valeur ajout√©e..."
                                                rows="6"
                                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                            />
                                        </div>

                                        <div className="bg-purple-50 border-l-4 border-majubah-orange p-4 rounded">
                                            <p className="text-sm text-gray-700">
                                                <i className="fas fa-lightbulb text-majubah-orange mr-2"></i>
                                                <strong>Conseil :</strong> Pensez √† un projet innovant et r√©aliste qui r√©pond √† une probl√©matique identifi√©e et aux besoins du march√©.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'competences' && (
                            <div>
                                <h2 className="text-3xl font-bold text-gray-800 mb-6">Suivi des comp√©tences</h2>
                                
                                <div className="bg-orange-50 border-l-4 border-majubah-orange p-4 rounded-lg mb-6">
                                    <p className="text-sm text-gray-700">
                                        <i className="fas fa-info-circle text-majubah-orange mr-2"></i>
                                        Auto-√©valuez votre progression sur chaque comp√©tence. Ces informations vous aideront √† structurer votre travail et seront visibles par votre formateur.
                                    </p>
                                </div>

                                <div className="space-y-4">
                                    {competences.map((comp) => (
                                        <div key={comp.id} className="bg-white rounded-xl shadow-md p-6 card-hover">
                                            <div className="flex items-start justify-between mb-4">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-3 mb-2">
                                                        <span className="bg-majubah-blue text-white px-3 py-1 rounded-full text-sm font-semibold">
                                                            {comp.code}
                                                        </span>
                                                        <h3 className="text-lg font-bold text-gray-800">{comp.titre}</h3>
                                                    </div>
                                                    <p className="text-gray-600 mb-2">{comp.description}</p>
                                                    <p className="text-sm text-gray-500 italic">
                                                        <i className="fas fa-check-circle text-green-600 mr-1"></i>
                                                        {comp.critere}
                                                    </p>
                                                    <p className="text-xs text-majubah-orange mt-2 font-medium">
                                                        <i className="fas fa-folder mr-1"></i>
                                                        {comp.activite}
                                                    </p>
                                                </div>
                                            </div>

                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                                <div>
                                                    <label className="block text-gray-700 font-medium mb-2">
                                                        Statut
                                                    </label>
                                                    <select
                                                        value={comp.statut}
                                                        onChange={(e) => updateCompetence(comp.id, 'statut', e.target.value)}
                                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                                    >
                                                        <option value="non_commence">Non commenc√©</option>
                                                        <option value="en_cours">En cours</option>
                                                        <option value="termine">Termin√©</option>
                                                    </select>
                                                </div>

                                                <div>
                                                    <label className="block text-gray-700 font-medium mb-2">
                                                        Auto-√©valuation
                                                    </label>
                                                    <select
                                                        value={comp.autoEval}
                                                        onChange={(e) => updateCompetence(comp.id, 'autoEval', e.target.value)}
                                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                                    >
                                                        <option value="">S√©lectionner</option>
                                                        <option value="A">A - Expertise</option>
                                                        <option value="B">B - Ma√Ætrise</option>
                                                        <option value="C">C - Acquis</option>
                                                        <option value="D">D - En cours d'acquisition</option>
                                                    </select>
                                                </div>
                                            </div>

                                            <div>
                                                <label className="block text-gray-700 font-medium mb-2">
                                                    Notes personnelles
                                                </label>
                                                <textarea
                                                    value={comp.notes}
                                                    onChange={(e) => updateCompetence(comp.id, 'notes', e.target.value)}
                                                    placeholder="Notez vos r√©flexions, sources utilis√©es, difficult√©s rencontr√©es..."
                                                    rows="3"
                                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                                />
                                            </div>

                                            {comp.commentaireFormateur && (
                                                <div className="mt-4 bg-blue-50 border-l-4 border-majubah-blue p-4 rounded">
                                                    <div className="flex items-start gap-2">
                                                        <i className="fas fa-comment-dots text-majubah-blue mt-1"></i>
                                                        <div className="flex-1">
                                                            <p className="font-semibold text-majubah-blue text-sm mb-1">Commentaire du formateur :</p>
                                                            <p className="text-gray-700 text-sm whitespace-pre-wrap">{comp.commentaireFormateur}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'businessplan' && (
                            <div>
                                <h2 className="text-3xl font-bold text-gray-800 mb-6">Sections du Business Plan</h2>
                                
                                <div className="bg-amber-50 border-l-4 border-amber-600 p-4 rounded-lg mb-6">
                                    <p className="text-sm text-gray-700">
                                        <i className="fas fa-file-alt text-amber-600 mr-2"></i>
                                        Votre dossier doit faire <strong>50 pages (+/- 10%)</strong> hors annexes. Cochez les sections compl√©t√©es au fur et √† mesure.
                                    </p>
                                </div>

                                <div className="mb-6">
                                    <div className="bg-white rounded-xl shadow-md p-4">
                                        <div className="flex items-center justify-between">
                                            <span className="text-gray-700 font-semibold">Progression du Business Plan</span>
                                            <span className="text-2xl font-bold text-majubah-orange">{progressionBP}%</span>
                                        </div>
                                        <div className="w-full bg-gray-200 rounded-full h-3 mt-3">
                                            <div
                                                className="bg-gradient-to-r from-orange-500 to-red-500 h-3 rounded-full transition-all duration-500"
                                                style={{ width: `${progressionBP}%` }}
                                            ></div>
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-4">
                                    {sections.map((section, index) => (
                                        <div key={index} className="bg-white rounded-xl shadow-md p-6 card-hover">
                                            <div className="flex items-start gap-4">
                                                <div className="flex items-center pt-1">
                                                    <input
                                                        type="checkbox"
                                                        checked={section.complete}
                                                        onChange={(e) => updateSection(index, 'complete', e.target.checked)}
                                                        className="w-5 h-5 text-majubah-orange rounded focus:ring-2 focus:ring-orange-500"
                                                    />
                                                </div>
                                                
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-3 mb-3">
                                                        <span className="bg-gray-600 text-white px-3 py-1 rounded-full text-sm font-semibold">
                                                            {index + 1}
                                                        </span>
                                                        <h3 className={`text-lg font-bold ${section.complete ? 'text-green-600' : 'text-gray-800'}`}>
                                                            {section.nom}
                                                            {section.complete && <i className="fas fa-check-circle ml-2"></i>}
                                                        </h3>
                                                    </div>
                                                    
                                                    <textarea
                                                        value={section.notes}
                                                        onChange={(e) => updateSection(index, 'notes', e.target.value)}
                                                        placeholder="Notes sur cette section : contenu pr√©vu, sources, points √† d√©velopper..."
                                                        rows="2"
                                                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500"
                                                    />
                                                    
                                                    {section.commentaireFormateur && (
                                                        <div className="mt-3 bg-blue-50 border-l-4 border-majubah-blue p-3 rounded">
                                                            <div className="flex items-start gap-2">
                                                                <i className="fas fa-comment-dots text-majubah-blue mt-1"></i>
                                                                <div className="flex-1">
                                                                    <p className="font-semibold text-majubah-blue text-sm mb-1">Commentaire du formateur :</p>
                                                                    <p className="text-gray-700 text-sm whitespace-pre-wrap">{section.commentaireFormateur}</p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <div className="mt-8 bg-white rounded-xl shadow-md p-6">
                                    <h3 className="text-xl font-bold text-gray-800 mb-4">
                                        <i className="fas fa-clipboard-check text-majubah-orange mr-2"></i>
                                        Rappel des exigences
                                    </h3>
                                    <ul className="space-y-2 text-gray-700">
                                        <li><i className="fas fa-check text-green-600 mr-2"></i>Format : Times New Roman ou Arial 12, interligne 1,5</li>
                                        <li><i className="fas fa-check text-green-600 mr-2"></i>50 pages (+/- 10%) hors annexes</li>
                                        <li><i className="fas fa-check text-green-600 mr-2"></i>Citations selon normes APA (7e √©dition)</li>
                                        <li><i className="fas fa-check text-green-600 mr-2"></i>Plagiat maximum 10%</li>
                                        <li><i className="fas fa-check text-green-600 mr-2"></i>Rendu : 8 juin 2026 (version papier + digitale)</li>
                                    </ul>
                                </div>
                            </div>
                        )}

                        {activeTab === 'feedbacks' && (
                            <div>
                                <h2 className="text-3xl font-bold text-gray-800 mb-6">
                                    <i className="fas fa-comments text-majubah-orange mr-3"></i>
                                    Feedbacks du formateur
                                </h2>

                                {/* Commentaire g√©n√©ral sur le projet */}
                                {projectInfo.commentaireFormateur && (
                                    <div className="bg-gradient-to-r from-majubah-blue to-blue-600 text-white rounded-xl shadow-lg p-6 mb-6">
                                        <h3 className="text-xl font-bold mb-3 flex items-center gap-2">
                                            <i className="fas fa-lightbulb"></i>
                                            Feedback g√©n√©ral sur votre projet
                                        </h3>
                                        <p className="text-lg leading-relaxed whitespace-pre-wrap">{projectInfo.commentaireFormateur}</p>
                                    </div>
                                )}

                                {/* Commentaires sur les comp√©tences */}
                                <div className="bg-white rounded-xl shadow-md p-6 mb-6">
                                    <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                        <i className="fas fa-tasks text-green-600"></i>
                                        Feedbacks sur vos comp√©tences
                                    </h3>
                                    {competences.filter(c => c.commentaireFormateur).length === 0 ? (
                                        <p className="text-gray-500 italic">Aucun feedback sur les comp√©tences pour le moment.</p>
                                    ) : (
                                        <div className="space-y-4">
                                            {competences.filter(c => c.commentaireFormateur).map((comp) => (
                                                <div key={comp.id} className="bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg">
                                                    <div className="flex items-center gap-2 mb-2">
                                                        <span className="bg-majubah-blue text-white px-2 py-1 rounded text-sm font-semibold">
                                                            {comp.code}
                                                        </span>
                                                        <h4 className="font-bold text-gray-800">{comp.titre}</h4>
                                                    </div>
                                                    <p className="text-gray-700 whitespace-pre-wrap">{comp.commentaireFormateur}</p>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                {/* Commentaires sur les sections BP */}
                                <div className="bg-white rounded-xl shadow-md p-6">
                                    <h3 className="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                                        <i className="fas fa-file-alt text-blue-600"></i>
                                        Feedbacks sur votre Business Plan
                                    </h3>
                                    {sections.filter(s => s.commentaireFormateur).length === 0 ? (
                                        <p className="text-gray-500 italic">Aucun feedback sur le Business Plan pour le moment.</p>
                                    ) : (
                                        <div className="space-y-4">
                                            {sections.filter(s => s.commentaireFormateur).map((section, index) => (
                                                <div key={index} className="bg-blue-50 border-l-4 border-majubah-blue p-4 rounded-r-lg">
                                                    <h4 className="font-bold text-gray-800 mb-2">{section.nom}</h4>
                                                    <p className="text-gray-700 whitespace-pre-wrap">{section.commentaireFormateur}</p>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                                {!projectInfo.commentaireFormateur && 
                                 competences.filter(c => c.commentaireFormateur).length === 0 && 
                                 sections.filter(s => s.commentaireFormateur).length === 0 && (
                                    <div className="bg-gray-50 border-2 border-dashed border-gray-300 rounded-xl p-12 text-center">
                                        <i className="fas fa-inbox text-gray-300 text-6xl mb-4"></i>
                                        <h3 className="text-xl font-bold text-gray-600 mb-2">Aucun feedback pour le moment</h3>
                                        <p className="text-gray-500">
                                            Votre formateur n'a pas encore ajout√© de commentaires.<br/>
                                            Continuez √† remplir vos comp√©tences et votre Business Plan !
                                        </p>
                                    </div>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        // Composant Dashboard Formateur
        function TeacherDashboard({ onLogout }) {
            const [selectedStudent, setSelectedStudent] = useState(null);
            const [studentData, setStudentData] = useState(null);
            const [students, setStudents] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showOnlyActive, setShowOnlyActive] = useState(false);
            
            // üî• SYNCHRONISATION TEMPS R√âEL avec onSnapshot
            useEffect(() => {
                console.log('üî• Mise en place de la synchronisation temps r√©el...');
                setLoading(true);
                
                // √âcoute en temps r√©el de TOUTE la collection students
                const unsubscribe = db.collection('students').onSnapshot(
                    (snapshot) => {
                        console.log('üì° MISE √Ä JOUR TEMPS R√âEL d√©tect√©e !');
                        console.log('üìä Documents re√ßus:', snapshot.size);
                        
                        const studentsData = studentsList.map(student => {
                            // Trouver le document correspondant √† cet √©tudiant
                            const doc = snapshot.docs.find(d => d.id === student.id);
                            const data = doc ? doc.data() : null;
                            
                            let progression = 0;
                            let projet = 'Non renseign√©';
                            let hasData = false;
                            
                            if (data) {
                                console.log(`‚úÖ ${student.id} (${student.prenom}) - Donn√©es trouv√©es`);
                                
                                // Calcul de la progression
                                if (data.competences && data.competences.length > 0) {
                                    hasData = true;
                                    const compTerminees = data.competences.filter(c => c.statut === 'termine');
                                    progression = Math.round((compTerminees.length / data.competences.length) * 100);
                                    console.log(`   üìä ${student.prenom}: ${compTerminees.length}/${data.competences.length} = ${progression}%`);
                                }
                                
                                if (data.projectInfo && data.projectInfo.nom) {
                                    hasData = true;
                                    projet = data.projectInfo.nom;
                                    console.log(`   üìÅ Projet: ${projet}`);
                                }
                                
                                if (data.sections && data.sections.length > 0) {
                                    const sectionsCompletes = data.sections.filter(s => s.complete === true);
                                    if (sectionsCompletes.length > 0) {
                                        hasData = true;
                                        console.log(`   üìÑ Sections: ${sectionsCompletes.length}/${data.sections.length}`);
                                    }
                                }
                            } else {
                                console.log(`‚ö™ ${student.id} (${student.prenom}) - Aucune donn√©e`);
                            }
                            
                            return {
                                id: student.id,
                                prenom: student.prenom,
                                nomComplet: student.nom,
                                nomAffiche: `${student.prenom} ${student.nom}`,
                                progression,
                                projet,
                                hasData,
                                lastUpdate: data?.lastUpdate || null
                            };
                        });
                        
                        const actifs = studentsData.filter(s => s.hasData);
                        console.log(`üìã √âtudiants actifs: ${actifs.length}/${studentsData.length}`);
                        actifs.forEach(s => console.log(`   ‚úÖ ${s.nomAffiche}: ${s.progression}%`));
                        
                        setStudents(studentsData);
                        setLoading(false);
                    },
                    (error) => {
                        console.error('‚ùå ERREUR listener Firebase:', error);
                        console.error('Code:', error.code);
                        console.error('Message:', error.message);
                        setLoading(false);
                    }
                );
                
                console.log('‚úÖ Listener temps r√©el activ√© !');
                console.log('üîÑ Toute modification Firebase sera d√©tect√©e instantan√©ment');
                
                // Nettoyage : d√©sactiver le listener quand le composant est d√©mont√©
                return () => {
                    console.log('üîå D√©connexion du listener temps r√©el');
                    unsubscribe();
                };
            }, []);

            // Fonction manuelle de rafra√Æchissement (optionnelle, pour forcer)
            const forceRefresh = () => {
                console.log('üîÑ Rafra√Æchissement manuel demand√©...');
                setLoading(true);
                // Le listener onSnapshot va automatiquement recharger
                setTimeout(() => setLoading(false), 500);
            };
                }
                
                setLoading(false);
            };

            const loadStudentData = async (studentId) => {
                const firebaseData = await loadFromFirebase(studentId);
                
                // Initialiser avec les structures par d√©faut si pas de donn√©es Firebase
                const defaultCompetences = competencesRef.map(c => ({ 
                    ...c, 
                    statut: 'non_commence', 
                    autoEval: '', 
                    notes: '', 
                    commentaireFormateur: '' 
                }));
                
                const defaultSections = sectionsBP.map(s => ({ 
                    nom: s, 
                    complete: false, 
                    notes: '', 
                    commentaireFormateur: '' 
                }));
                
                if (firebaseData && firebaseData.competences && firebaseData.competences.length > 0) {
                    // L'√©tudiant a des donn√©es existantes
                    setStudentData({
                        id: studentId,
                        competences: firebaseData.competences,
                        sections: firebaseData.sections || defaultSections,
                        project: firebaseData.projectInfo || { nom: '', description: '', secteur: '', commentaireFormateur: '' }
                    });
                } else {
                    // Nouvel √©tudiant ou pas encore de donn√©es - initialiser avec les structures par d√©faut
                    setStudentData({
                        id: studentId,
                        competences: defaultCompetences,
                        sections: defaultSections,
                        project: { nom: '', description: '', secteur: '', commentaireFormateur: '' }
                    });
                }
                
                setSelectedStudent(studentId);
            };

            const updateStudentComment = (type, id, comment) => {
                if (!studentData) return;
                
                let updatedData = { ...studentData };
                
                if (type === 'competence') {
                    updatedData.competences = updatedData.competences.map(c => 
                        c.id === id ? { ...c, commentaireFormateur: comment } : c
                    );
                } else if (type === 'section') {
                    updatedData.sections = updatedData.sections.map((s, i) => 
                        i === id ? { ...s, commentaireFormateur: comment } : s
                    );
                } else if (type === 'project') {
                    updatedData.project = { ...updatedData.project, commentaireFormateur: comment };
                }
                
                // Ne pas sauvegarder automatiquement - l'utilisateur cliquera sur "Enregistrer"
                setStudentData(updatedData);
            };

            const moyenneProgression = students.length > 0 
                ? Math.round(students.reduce((sum, s) => sum + s.progression, 0) / students.length)
                : 0;

            const avances = students.filter(s => s.progression >= 70).length;
            const enRetard = students.filter(s => s.progression < 30).length;

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="inline-block animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-majubah-orange mb-4"></div>
                            <p className="text-xl text-gray-700 font-semibold">Chargement des donn√©es...</p>
                            <p className="text-sm text-gray-500 mt-2">Connexion √† Firebase</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50">
                    <header className="gradient-bg text-white shadow-lg">
                        <div className="container mx-auto px-4 py-4">
                            <div className="flex justify-between items-center">
                                <div className="logo-container">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" className="w-12 h-12">
                                        <ellipse cx="100" cy="90" rx="50" ry="45" fill="#ffffff"/>
                                        <path d="M 60 60 Q 50 40 65 50 Z" fill="#ffffff"/>
                                        <path d="M 140 60 Q 150 40 135 50 Z" fill="#ffffff"/>
                                        <ellipse cx="80" cy="85" rx="8" ry="12" fill="#eb5436"/>
                                        <ellipse cx="120" cy="85" rx="8" ry="12" fill="#eb5436"/>
                                        <ellipse cx="82" cy="83" rx="3" ry="5" fill="#194759"/>
                                        <ellipse cx="122" cy="83" rx="3" ry="5" fill="#194759"/>
                                        <ellipse cx="100" cy="105" rx="15" ry="12" fill="#f0f0f0"/>
                                        <path d="M 100 100 L 95 108 Q 100 110 105 108 Z" fill="#eb5436"/>
                                        <line x1="70" y1="100" x2="40" y2="95" stroke="#ffffff" strokeWidth="2"/>
                                        <line x1="70" y1="105" x2="40" y2="105" stroke="#ffffff" strokeWidth="2"/>
                                        <line x1="130" y1="100" x2="160" y2="95" stroke="#ffffff" strokeWidth="2"/>
                                        <line x1="130" y1="105" x2="160" y2="105" stroke="#ffffff" strokeWidth="2"/>
                                        <path d="M 70 120 Q 100 140 130 120" fill="none" stroke="#ffffff" strokeWidth="3"/>
                                    </svg>
                                    <div>
                                        <h1 className="text-2xl font-bold">Dashboard Formateur - MDO 2024-2026</h1>
                                        <p className="text-blue-100 text-sm">
                                            Suivi de 19 √©tudiants
                                            {students.filter(s => s.hasData).length > 0 && (
                                                <span className="ml-3 bg-green-500 text-white px-2 py-1 rounded-full text-xs">
                                                    {students.filter(s => s.hasData).length} actif{students.filter(s => s.hasData).length > 1 ? 's' : ''}
                                                </span>
                                            )}
                                        </p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    <button
                                        onClick={forceRefresh}
                                        className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-blue-700 transition"
                                        disabled={loading}
                                        title="Rafra√Æchir les donn√©es"
                                    >
                                        <i className={`fas fa-sync-alt mr-2 ${loading ? 'animate-spin' : ''}`}></i>
                                        Rafra√Æchir
                                    </button>
                                    <button
                                        onClick={onLogout}
                                        className="btn-deconnexion px-4 py-2 rounded-lg font-medium"
                                    >
                                        <i className="fas fa-sign-out-alt mr-2"></i>
                                        D√©connexion
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="container mx-auto px-4 py-8">
                        <h2 className="text-3xl font-bold text-gray-800 mb-6">Vue d'ensemble de la promotion</h2>

                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div className="bg-white rounded-xl shadow-md p-6">
                                <div className="flex items-center justify-between mb-2">
                                    <h3 className="text-gray-600 font-semibold">√âtudiants</h3>
                                    <i className="fas fa-users text-majubah-blue text-2xl"></i>
                                </div>
                                <div className="text-4xl font-bold text-majubah-blue">{students.length}</div>
                            </div>

                            <div className="bg-white rounded-xl shadow-md p-6">
                                <div className="flex items-center justify-between mb-2">
                                    <h3 className="text-gray-600 font-semibold">Progression moyenne</h3>
                                    <i className="fas fa-chart-line text-majubah-orange text-2xl"></i>
                                </div>
                                <div className="text-4xl font-bold text-majubah-orange">{moyenneProgression}%</div>
                            </div>

                            <div className="bg-white rounded-xl shadow-md p-6">
                                <div className="flex items-center justify-between mb-2">
                                    <h3 className="text-gray-600 font-semibold">En avance</h3>
                                    <i className="fas fa-check-circle text-green-600 text-2xl"></i>
                                </div>
                                <div className="text-4xl font-bold text-green-600">{avances}</div>
                                <p className="text-sm text-gray-600">‚â• 70%</p>
                            </div>

                            <div className="bg-white rounded-xl shadow-md p-6">
                                <div className="flex items-center justify-between mb-2">
                                    <h3 className="text-gray-600 font-semibold">√Ä surveiller</h3>
                                    <i className="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                                </div>
                                <div className="text-4xl font-bold text-red-600">{enRetard}</div>
                                <p className="text-sm text-gray-600">&lt; 30%</p>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-md overflow-hidden">
                            <div className="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                                <h3 className="text-xl font-bold text-gray-800">
                                    <i className="fas fa-list text-majubah-orange mr-2"></i>
                                    Liste des √©tudiants
                                </h3>
                                <label className="flex items-center gap-2 cursor-pointer">
                                    <input
                                        type="checkbox"
                                        checked={showOnlyActive}
                                        onChange={(e) => setShowOnlyActive(e.target.checked)}
                                        className="w-4 h-4 text-majubah-orange rounded"
                                    />
                                    <span className="text-sm text-gray-700 font-medium">
                                        Uniquement les actifs ({students.filter(s => s.hasData).length})
                                    </span>
                                </label>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-gray-50">
                                        <tr>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                ID
                                            </th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Nom
                                            </th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Projet
                                            </th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Progression
                                            </th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Statut
                                            </th>
                                            <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Actions
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody className="bg-white divide-y divide-gray-200">
                                        {students.filter(s => !showOnlyActive || s.hasData).map((student) => (
                                            <tr key={student.id} className="hover:bg-gray-50">
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                    {student.id}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">
                                                    {student.nomAffiche}
                                                </td>
                                                <td className="px-6 py-4 text-sm text-gray-600">
                                                    {student.projet}
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <div className="flex items-center">
                                                        <div className="w-32 bg-gray-200 rounded-full h-2 mr-3">
                                                            <div
                                                                className={`h-2 rounded-full ${
                                                                    student.progression >= 70
                                                                        ? 'bg-green-500'
                                                                        : student.progression >= 30
                                                                        ? 'bg-yellow-500'
                                                                        : 'bg-red-500'
                                                                }`}
                                                                style={{ width: `${student.progression}%` }}
                                                            ></div>
                                                        </div>
                                                        <span className="text-sm font-medium text-gray-700">
                                                            {student.progression}%
                                                        </span>
                                                    </div>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <span
                                                        className={`px-3 py-1 rounded-full text-xs font-semibold ${
                                                            student.progression >= 70
                                                                ? 'bg-green-100 text-green-800'
                                                                : student.progression >= 30
                                                                ? 'bg-yellow-100 text-yellow-800'
                                                                : 'bg-red-100 text-red-800'
                                                        }`}
                                                    >
                                                        {student.progression >= 70
                                                            ? 'En avance'
                                                            : student.progression >= 30
                                                            ? 'Dans les temps'
                                                            : 'En retard'}
                                                    </span>
                                                </td>
                                                <td className="px-6 py-4 whitespace-nowrap">
                                                    <button
                                                        onClick={() => loadStudentData(student.id)}
                                                        className="bg-majubah-orange text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-majubah-blue transition"
                                                    >
                                                        <i className="fas fa-eye mr-2"></i>
                                                        Voir d√©tails
                                                    </button>
                                                </td>
                                            </tr>
                                        ))}
                                        {students.filter(s => !showOnlyActive || s.hasData).length === 0 && (
                                            <tr>
                                                <td colSpan="6" className="px-6 py-12 text-center">
                                                    <div className="flex flex-col items-center justify-center text-gray-400">
                                                        <i className="fas fa-user-slash text-5xl mb-4"></i>
                                                        <p className="text-lg font-semibold">Aucun √©tudiant actif pour le moment</p>
                                                        <p className="text-sm mt-2">Les √©tudiants appara√Ætront ici d√®s qu'ils auront rempli des donn√©es</p>
                                                    </div>
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {selectedStudent && studentData && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onClick={() => setSelectedStudent(null)}>
                                <div className="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                                    <div className="sticky top-0 bg-gradient-bg text-white p-6 rounded-t-xl flex justify-between items-center">
                                        <div>
                                            <h2 className="text-2xl font-bold">{selectedStudent}</h2>
                                            <p className="text-blue-100 text-sm">Ajouter des commentaires formateur</p>
                                        </div>
                                        <button
                                            onClick={() => setSelectedStudent(null)}
                                            className="text-white hover:bg-white hover:text-majubah-blue rounded-full w-10 h-10 flex items-center justify-center transition"
                                        >
                                            <i className="fas fa-times text-xl"></i>
                                        </button>
                                    </div>
                                    
                                    <div className="p-6">
                                        <h3 className="text-xl font-bold text-gray-800 mb-4">Comp√©tences</h3>
                                        <div className="space-y-4">
                                            {studentData.competences.map((comp) => (
                                                <div key={comp.id} className="bg-gray-50 rounded-lg p-4">
                                                    <div className="flex items-center gap-2 mb-2">
                                                        <span className="bg-majubah-blue text-white px-2 py-1 rounded text-sm font-semibold">
                                                            {comp.code}
                                                        </span>
                                                        <h4 className="font-bold text-gray-800">{comp.titre}</h4>
                                                        <span className={`ml-auto px-2 py-1 rounded-full text-xs font-semibold ${
                                                            comp.statut === 'termine' ? 'bg-green-200 text-green-800' :
                                                            comp.statut === 'en_cours' ? 'bg-yellow-200 text-yellow-800' :
                                                            'bg-gray-200 text-gray-700'
                                                        }`}>
                                                            {comp.statut === 'termine' ? 'Termin√©' : comp.statut === 'en_cours' ? 'En cours' : 'Non commenc√©'}
                                                        </span>
                                                    </div>
                                                    {comp.notes && (
                                                        <div className="text-sm text-gray-600 mb-2 bg-white p-2 rounded">
                                                            <strong>Notes √©tudiant:</strong> {comp.notes}
                                                        </div>
                                                    )}
                                                    <div>
                                                        <label className="block text-sm font-medium text-majubah-blue mb-1">
                                                            üí¨ Votre commentaire formateur:
                                                        </label>
                                                        <textarea
                                                            value={comp.commentaireFormateur || ''}
                                                            onChange={(e) => updateStudentComment('competence', comp.id, e.target.value)}
                                                            placeholder="Ajoutez un feedback pour l'√©tudiant..."
                                                            rows="2"
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-majubah-orange text-sm"
                                                        />
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        
                                        <h3 className="text-xl font-bold text-gray-800 mb-4 mt-8">Sections du Business Plan</h3>
                                        <div className="space-y-3">
                                            {studentData.sections.map((section, index) => (
                                                <div key={index} className="bg-gray-50 rounded-lg p-4">
                                                    <div className="flex items-center gap-2 mb-2">
                                                        <input
                                                            type="checkbox"
                                                            checked={section.complete}
                                                            disabled
                                                            className="w-4 h-4"
                                                        />
                                                        <h4 className="font-bold text-gray-800">{section.nom}</h4>
                                                    </div>
                                                    {section.notes && (
                                                        <div className="text-sm text-gray-600 mb-2 bg-white p-2 rounded">
                                                            <strong>Notes √©tudiant:</strong> {section.notes}
                                                        </div>
                                                    )}
                                                    <div>
                                                        <label className="block text-sm font-medium text-majubah-blue mb-1">
                                                            üí¨ Votre commentaire formateur:
                                                        </label>
                                                        <textarea
                                                            value={section.commentaireFormateur || ''}
                                                            onChange={(e) => updateStudentComment('section', index, e.target.value)}
                                                            placeholder="Ajoutez un feedback sur cette section..."
                                                            rows="2"
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-majubah-orange text-sm"
                                                        />
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        
                                        <h3 className="text-xl font-bold text-gray-800 mb-4 mt-8">Informations du Projet</h3>
                                        <div className="bg-gray-50 rounded-lg p-4">
                                            <div className="grid grid-cols-1 gap-4 mb-4">
                                                <div>
                                                    <label className="block text-sm font-semibold text-gray-700 mb-1">Nom du projet</label>
                                                    <div className="bg-white p-3 rounded border border-gray-200">
                                                        {studentData.project.nom || <span className="text-gray-400 italic">Non renseign√©</span>}
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-semibold text-gray-700 mb-1">Description</label>
                                                    <div className="bg-white p-3 rounded border border-gray-200 min-h-[60px]">
                                                        {studentData.project.description || <span className="text-gray-400 italic">Non renseign√©</span>}
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-semibold text-gray-700 mb-1">Secteur d'activit√©</label>
                                                    <div className="bg-white p-3 rounded border border-gray-200">
                                                        {studentData.project.secteur || <span className="text-gray-400 italic">Non renseign√©</span>}
                                                    </div>
                                                </div>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium text-majubah-blue mb-1">
                                                    üí¨ Votre commentaire g√©n√©ral sur le projet:
                                                </label>
                                                <textarea
                                                    value={studentData.project.commentaireFormateur || ''}
                                                    onChange={(e) => updateStudentComment('project', null, e.target.value)}
                                                    placeholder="Ajoutez un feedback g√©n√©ral sur le projet entrepreneurial..."
                                                    rows="3"
                                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-majubah-orange text-sm"
                                                />
                                            </div>
                                        </div>
                                        
                                        <div className="mt-6 flex justify-end gap-3">
                                            <button
                                                onClick={() => setSelectedStudent(null)}
                                                className="bg-gray-500 text-white px-6 py-3 rounded-lg font-medium hover:bg-gray-600 transition"
                                            >
                                                <i className="fas fa-times mr-2"></i>
                                                Fermer sans sauvegarder
                                            </button>
                                            <button
                                                onClick={async () => {
                                                    // Sauvegarder dans Firebase
                                                    await saveToFirebase(selectedStudent, {
                                                        studentName: selectedStudent,
                                                        competences: studentData.competences,
                                                        sections: studentData.sections,
                                                        projectInfo: studentData.project,
                                                        lastUpdate: new Date().toISOString()
                                                    });
                                                    alert('‚úÖ Commentaires sauvegard√©s avec succ√®s !\n\nL\'√©tudiant verra vos feedbacks √† sa prochaine connexion.');
                                                    setSelectedStudent(null);
                                                    // Pas besoin de rafra√Æchir : le listener temps r√©el met √† jour automatiquement !
                                                }}
                                                className="bg-green-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-green-700 transition"
                                            >
                                                <i className="fas fa-save mr-2"></i>
                                                Enregistrer les commentaires
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        // Application principale
        function App() {
            const [user, setUser] = useState(null);

            const handleLogin = (type, name) => {
                setUser({ type, name });
            };

            const handleLogout = () => {
                setUser(null);
            };

            if (!user) {
                return <LoginPage onLogin={handleLogin} />;
            }

            if (user.type === 'teacher') {
                return <TeacherDashboard onLogout={handleLogout} />;
            }

            return <StudentDashboard studentName={user.name} onLogout={handleLogout} />;
        }

        // Render
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
